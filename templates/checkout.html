<!DOCTYPE html>
<html lang="en">
<head>
  <title>Pragman Family Farms - Checkout</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS & Google Fonts -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <style>
    body {
      font: 400 15px Lato, sans-serif;
      line-height: 1.8;
      color: #818181;
    }
    .navbar {
      margin-bottom: 0;
      background-color: #343132;
      z-index: 9999;
      border: 0;
      font-size: 12px !important;
      line-height: 1.42857143 !important;
      letter-spacing: 4px;
      border-radius: 0;
      font-family: Montserrat, sans-serif;
    }
    .navbar li a,
    .navbar .navbar-brand {
      color: #fff !important;
    }
    .navbar-nav li a:hover,
    .navbar-nav li.active a {
      color: #343132 !important;
      background-color: #fff !important;
    }
    .checkout-container {
      margin-top: 80px;
    }
    .btn-custom {
      background-color: #122340;
      color: #fff;
    }
    .btn-custom:hover {
      background-color: #fff;
      color: #122340;
      border: 1px solid #122340;
    }
  </style>
  <!-- Load Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
  <!-- NAVIGATION BAR (Same as store page) -->
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
         <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
           <span class="icon-bar"></span>
           <span class="icon-bar"></span>
           <span class="icon-bar"></span>
         </button>
         <a class="navbar-brand" href="/#main">
           <img src="{{ url_for('static', filename='logo3.png') }}" alt="Pragman Family Farms Logo" style="height: 30px;">
         </a>
      </div>
      <div class="collapse navbar-collapse" id="myNavbar">
         <ul class="nav navbar-nav navbar-right">
           <li><a href="/#main">HOME</a></li>
           <li><a href="/#vision">OUR VISION</a></li>
           <li><a href="/#technology">TECHNOLOGY</a></li>
           <li><a href="/#about">ABOUT</a></li>
           <li><a href="/store">STORE</a></li>
           <li><a href="/#contact">CONTACT</a></li>
         </ul>
      </div>
    </div>
  </nav>

  <!-- CHECKOUT CONTENT -->
  <div class="container checkout-container">
    <h2 class="text-center">Checkout</h2>
    {% if cart %}
      <table class="table table-bordered table-striped">
         <thead>
           <tr>
              <th>Item</th>
              <th>Qty</th>
              <th>Price</th>
              <th>Subtotal</th>
           </tr>
         </thead>
         <tbody>
           {% set ns = namespace(total=0) %}
           {% for item in cart %}
             {% set price = item.price | float %}
             {% set quantity = item.quantity | int %}
             {% set subtotal = price * quantity %}
             {% set ns.total = ns.total + subtotal %}
             <tr>
               <td>{{ item.product_id }}</td>
               <td>{{ quantity }}</td>
               <td>${{ "%.2f"|format(price) }}</td>
               <td>${{ "%.2f"|format(subtotal) }}</td>
             </tr>
           {% endfor %}
         </tbody>
         <tfoot>
           <tr>
             <td colspan="3"><strong>Total</strong></td>
             <td><strong>${{ "%.2f"|format(ns.total) }}</strong></td>
           </tr>
         </tfoot>
      </table>
      <button id="checkout-button" class="btn btn-success btn-custom">Pay with Stripe</button>
    {% else %}
      <p>Your cart is empty.</p>
    {% endif %}
  </div>

  <script>
    // Initialize Stripe.js with the publishable key provided by the Flask app
    var stripe = Stripe("{{ publishable_key }}");
    var checkoutButton = document.getElementById("checkout-button");
    if (checkoutButton) {
      checkoutButton.addEventListener("click", function () {
        // Create a new Checkout Session using the server endpoint
        fetch("/create-checkout-session", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
        })
        .then(function (response) {
          return response.json();
        })
        .then(function (session) {
          // Redirect the customer to Stripe Checkout
          return stripe.redirectToCheckout({ sessionId: session.id });
        })
        .then(function (result) {
          if (result.error) {
            alert(result.error.message);
          }
        })
        .catch(function (error) {
          console.error("Error:", error);
        });
      });
    }
  </script>
</body>
</html>
